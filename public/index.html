<!DOCTYPE html>
<html>
<head>
<title>BMTC Student Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* üåå SPACE BACKGROUND */
body {
    margin: 0;
    font-family: 'Poppins', Arial, sans-serif;
    overflow-x: hidden;
    color: white;
    padding: 20px;
    max-width: 700px;
    margin: auto;
    position: relative;
}

/* üå† ANIMATED STAR BACKGROUND */
body::before {
    content: "";
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at top, #0a0a15, #000000 80%);
    z-index: -3;
}

#stars, #stars2, #stars3 {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    display: block;
    z-index: -2;
    background-repeat: repeat;
}

#stars {
    background-image: url('https://i.imgur.com/YkYv8Ee.png');
    animation: moveStars 150s linear infinite;
}

#stars2 {
    background-image: url('https://i.imgur.com/DR3HhUh.png');
    animation: moveStars 250s linear infinite;
}

#stars3 {
    background-image: url('https://i.imgur.com/YkYv8Ee.png');
    animation: moveStars 400s linear infinite;
}

@keyframes moveStars {
    from { transform: translateY(0); }
    to { transform: translateY(-2000px); }
}

/* üåà TITLE */
h2 {
    text-align: center;
    font-size: 30px;
    margin-bottom: 20px;
    color: #00eaff;
    text-shadow: 0 0 10px #00eaff;
}

/* CARDS */
.card {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 15px;
    margin-top: 20px;
    backdrop-filter: blur(10px);
}

/* INPUT */
input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border: none;
    border-radius: 10px;
    outline: none;
    font-size: 16px;
    background: rgba(255,255,255,0.15);
    color: white;
}

/* BUTTONS */
button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    background: linear-gradient(45deg, #00eaff, #005dff);
    color: black;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    margin: 10px 0;
    box-shadow: 0 0 10px #00eaff;
}

button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 20px #00eaff;
}

/* SUGGESTION ITEM */
.bus {
    padding: 10px;
    border-bottom: 1px dashed #88c8ff;
    color: #e5f4ff;
}
</style>
</head>

<body>

<div id="stars"></div>
<div id="stars2"></div>
<div id="stars3"></div>

<h2>üöç MVJCE ‚áÑ Home ‚Äî Bus Finder</h2>

<label>Enter your nearest bus stop:</label>
<input id="stopInput" placeholder="Example: Tin Factory" oninput="autoSearch()" />

<button onclick="searchStop()">Search</button>

<div id="stopResults" class="card" style="display:none;"></div>

<div id="directionBox" class="card" style="display:none;">
    <p>Selected stop: <span id="selectedStop"></span></p>
    <button onclick="toHome()">MVJCE ‚Üí Home</button>
    <button onclick="toCollege()">Home ‚Üí MVJCE</button>
</div>

<div id="busResults" class="card" style="display:none;"></div>

<script>
let selectedStopId = null;
let selectedStopName = null;
let MVJCE_ID = 22320;

/* LIVE SEARCH WHILE TYPING */
async function autoSearch() {
    let query = document.getElementById("stopInput").value.trim();
    if (query.length < 3) return;
    searchStop();
}

/* SEARCH STOP */
async function searchStop() {
    let q = document.getElementById("stopInput").value;
    let box = document.getElementById("stopResults");
    box.style.display = "block";
    box.innerHTML = "Loading...";

    let res = await fetch("/api/searchStop", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ q })
    });

    let data = await res.json();
    if (!data.ok) {
        box.innerHTML = "Error fetching stops";
        return;
    }

    box.innerHTML = "";

    data.stops.forEach(s => {
        let div = document.createElement("div");
        div.className = "bus";
        div.style.cursor = "pointer";
        div.innerHTML = `${s.routename} (ID: ${s.routeid})`;

        div.onclick = () => {
            selectedStopId = s.routeid;
            selectedStopName = s.routename;
            document.getElementById("selectedStop").innerText =
                `${s.routename} (${s.routeid})`;

            box.style.display = "none"; // hide suggestions
            document.getElementById("directionBox").style.display = "block";
        };

        box.appendChild(div);
    });
}

/* DIRECTION BUTTONS */
function toHome() { getTrip(MVJCE_ID, selectedStopId); }
function toCollege() { getTrip(selectedStopId, MVJCE_ID); }

/* GET TRIP INFO */
async function getTrip(from, to) {
    let box = document.getElementById("busResults");
    box.style.display = "block";
    box.innerHTML = "Loading...";

    let res = await fetch("/api/getTrip", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fromStationId: from, toStationId: to })
    });

    let data = await res.json();

    box.innerHTML = "<h3>Upcoming Buses</h3>";

    if (!data.ok) {
        box.innerHTML += "<p>Error fetching trips</p>";
        return;
    }

    let groups = [];

    if (Array.isArray(data.trips)) {
        groups = data.trips;
    } else if (typeof data.trips === "object") {
        if (Array.isArray(data.trips.directRoutes)) {
            data.trips.directRoutes.forEach(r => groups.push([r]));
        }
        if (Array.isArray(data.trips.transferRoutes)) {
            data.trips.transferRoutes.forEach(routeArr => groups.push(routeArr));
        }
    }

    if (!groups.length) {
        box.innerHTML += "<p>No buses found right now.</p>";
        return;
    }

    groups.forEach(route => {
        let trip = route[0];
        let div = document.createElement("div");
        div.className = "bus";

        div.innerHTML = `
            <b>Route: ${trip.routeno}</b><br>
            From ETA: ${trip.etaFromStation}<br>
            To ETA: ${trip.etaToStation}<br>
            Bus No: ${trip.busNo}<br>
            Duration: ${trip.duration}
        `;
        box.appendChild(div);
    });
}
</script>

</body>
</html>
